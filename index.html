<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">






















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">

<link rel="stylesheet" href="/css/main.css?v=7.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.2.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.2.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.2.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="记录IT路上的风风雨雨-paopaolee">
<meta name="keywords" content="paopaolee fullstack gopher jser geeker">
<meta property="og:type" content="website">
<meta property="og:title" content="paopaolee">
<meta property="og:url" content="https://paopaolee.github.io.com/index.html">
<meta property="og:site_name" content="paopaolee">
<meta property="og:description" content="记录IT路上的风风雨雨-paopaolee">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="paopaolee">
<meta name="twitter:description" content="记录IT路上的风风雨雨-paopaolee">





  
  
  <link rel="canonical" href="https://paopaolee.github.io.com/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>paopaolee</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
          <img class="header-custom-logo" src="/uploads/paopaolee.png" alt="paopaolee">
      </a>
    </div>
    
      
        <p class="site-subtitle">paopaolee</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">

    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://paopaolee.github.io.com/web/LP20190802A/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="paopaolee">
      <meta itemprop="description" content="记录IT路上的风风雨雨-paopaolee">
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="paopaolee">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/web/LP20190802A/" class="post-title-link" itemprop="url">漫谈Web--H5唤醒</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-08-02 17:16:58" itemprop="dateCreated datePublished" datetime="2019-08-02T17:16:58+08:00">2019-08-02</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-08-03 19:27:04" itemprop="dateModified" datetime="2019-08-03T19:27:04+08:00">2019-08-03</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/web/" itemprop="url" rel="index"><span itemprop="name">web</span></a></span>

                
                
              
            </span>
          

          
             <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                <span class="post-count">2.7k word</span>
              </span>
          


          
             <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                <span class="post-count">10 mins</span>
              </span>
          

          
            
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <blockquote>
<p>“There is no silver bullet”          —Fred Brooks</p>
</blockquote>
          <!--noindex-->
          
            <div class="post-button text-center">
              <a class="btn" href="/web/LP20190802A/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://paopaolee.github.io.com/web/LP20190710A/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="paopaolee">
      <meta itemprop="description" content="记录IT路上的风风雨雨-paopaolee">
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="paopaolee">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/web/LP20190710A/" class="post-title-link" itemprop="url">Set、Map、WeakSet、WeakMap的区别</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-07-10 14:20:01" itemprop="dateCreated datePublished" datetime="2019-07-10T14:20:01+08:00">2019-07-10</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-07-11 15:05:02" itemprop="dateModified" datetime="2019-07-11T15:05:02+08:00">2019-07-11</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/web/" itemprop="url" rel="index"><span itemprop="name">web</span></a></span>

                
                
              
            </span>
          

          
             <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                <span class="post-count">2.2k word</span>
              </span>
          


          
             <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                <span class="post-count">9 mins</span>
              </span>
          

          
            
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <blockquote>
<p>“Good programmers use their brains, but good guidelines save us having to think out every case.”—Francis Glassborow</p>
</blockquote>
          <!--noindex-->
          
            <div class="post-button text-center">
              <a class="btn" href="/web/LP20190710A/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://paopaolee.github.io.com/web/LP20190709A/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="paopaolee">
      <meta itemprop="description" content="记录IT路上的风风雨雨-paopaolee">
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="paopaolee">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/web/LP20190709A/" class="post-title-link" itemprop="url">漫谈Web--JWT</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-07-09 16:29:27 / Modified: 17:49:00" itemprop="dateCreated datePublished" datetime="2019-07-09T16:29:27+08:00">2019-07-09</time>
            </span>
          

          
            

            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/web/" itemprop="url" rel="index"><span itemprop="name">web</span></a></span>

                
                
              
            </span>
          

          
             <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                <span class="post-count">1.9k word</span>
              </span>
          


          
             <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                <span class="post-count">6 mins</span>
              </span>
          

          
            
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <blockquote>
<p>“The most amazing achievement of the computer software industry is its continuing cancellation of the steady and staggering gains made by the computer hardware industry.”          —Henry Petroski</p>
</blockquote>
          <!--noindex-->
          
            <div class="post-button text-center">
              <a class="btn" href="/web/LP20190709A/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://paopaolee.github.io.com/web/LP20190706A/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="paopaolee">
      <meta itemprop="description" content="记录IT路上的风风雨雨-paopaolee">
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="paopaolee">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/web/LP20190706A/" class="post-title-link" itemprop="url">[译]Web视频流原理：简介篇</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-07-06 15:51:18" itemprop="dateCreated datePublished" datetime="2019-07-06T15:51:18+08:00">2019-07-06</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-08-07 18:14:57" itemprop="dateModified" datetime="2019-08-07T18:14:57+08:00">2019-08-07</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/web/" itemprop="url" rel="index"><span itemprop="name">web</span></a></span>

                
                
              
            </span>
          

          
             <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                <span class="post-count">4.8k word</span>
              </span>
          


          
             <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                <span class="post-count">18 mins</span>
              </span>
          

          
            
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>原文: <a href="https://medium.com/canal-tech/how-video-streaming-works-on-the-web-an-introduction-7919739f7e1" target="_blank" rel="noopener">How video streaming works on the web: An introduction</a></p>
<h3 id="渴求原生视频API"><a href="#渴求原生视频API" class="headerlink" title="渴求原生视频API"></a>渴求原生视频API</h3><p>从2000年代早期到晚期，网络上的视频播放主要依赖于Flash插件。这是因为在那个时候，浏览器中没有实现其他的视频流播放方案。用户如果想要在网页中播放视频，只能通过安装第三方插件，比如flash或者silverlight，来播放视频，否则根本无法观看视频。</p>
<p>为了填写这一空白，网页超文本应用技术工作小组（WHATWG）开始着手制订新版本的HTML标准，其中就包括原生视频和音频（无需插件）播放。这个新版本的HTML标准就是大家熟知的HTML5.</p>
<p>于是HTML5给web开发带来<code>&lt;Video&gt;</code>标签，这个新标签允许开发者直接通过HTML加载视频资源，类似于通过<code>&lt;img&gt;</code>标签加载图片资源。这个一个很酷的事情，但是从媒体网站的角度看来，这种类似图片加载的方式似乎不足以取代flash，原因如下：</p>
<ol>
<li>用户可能需要在多个质量视频间进行即时切换</li>
<li>直播是另一个使用场景，看起来很难以这种方式实现</li>
<li>如果内容像Netflix一样流式传输，那么基于用户偏好更新内容的音频语言呢？</li>
</ol>
<p>值得庆幸的是，随着HTML5规范的到来，以上所有这些问题都可以在大多数浏览器上解决。本文将详细介绍今天的web如何做到这些的。</p>
<h3 id="Video标签"><a href="#Video标签" class="headerlink" title="Video标签"></a>Video标签</h3><p>前面有提到，使用HTML5在网页里加载视频是相当直观，你只需要在你的页面中添加一个video标签以及给它一些相关的属性。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>My Video<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">video</span> <span class="attr">src</span>=<span class="string">"some_video.mp4"</span> <span class="attr">width</span>=<span class="string">"1280px"</span> <span class="attr">height</span>=<span class="string">"720px"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>video标签将允许您的页面直接在任何支持相应编解码器（当然还有HTML5）的浏览器上流式传输some_video.mp4。同时HTML5还提供了丰富的API，比如视频的播放，暂停，快进以及改变播放速率。</p>
<p>然而，现如今我们在网站上看到的视频拥有更过更复杂的行为远远超过了HTML5提供给我们的。例如，视频质量切换和实时流媒体。这些网站实际上仍然使用视频标签。但是，他们不是简单地在src属性中设置视频地址，而是使用更强大的Web API，即媒体资源扩展（Media Source Extensions）。</p>
<h3 id="媒体资源扩展（Media-Source-Extensions）"><a href="#媒体资源扩展（Media-Source-Extensions）" class="headerlink" title="媒体资源扩展（Media Source Extensions）"></a>媒体资源扩展（Media Source Extensions）</h3><p>媒体资源扩展（Media Source Extensions简称“MSE”， 是一个现今多数浏览器都遵守的规范。它创建来是为了让HTML和JavaScript允许那些复杂的媒体用例。</p>
<p>这些“扩展”将MediaSource对象添加到JavaScript，顾名思义，它就是视频资源，或者更简单地说，这是表示我们视频数据的对象。如上面所说，我们仍然会使用<code>&lt;video&gt;</code>, 也许更令人惊讶的是,我们仍然使用是<code>src</code>属性，只是我们不再链接到一个视频文件，而是链接到一个媒体资源对象。</p>
<p>你可能对<code>而是链接到一个媒体资源对象</code>感到很疑惑，这里我们不再说它是一个URL，而我们说它是一个JavaScript语言中的抽象概念，那怎么可以将它称为视频标签上的URL，这是在HTML中定义的？</p>
<p>为了允许这种用例，W3C定义了URL.createObjectURL静态方法。此API允许创建一个URL，该URL实际上不会引用在线可用的资源，而是直接引用在客户端上创建的JavaScript对象。这就是MediaSource附加到视频标签的原理。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> videoTag = <span class="built_in">document</span>.getElementById(<span class="string">"my-video"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// creating the MediaSource, just with the "new" keyword, and the URL for it</span></span><br><span class="line"><span class="keyword">const</span> myMediaSource = <span class="keyword">new</span> MediaSource();</span><br><span class="line"><span class="keyword">const</span> url = URL.createObjectURL(myMediaSource);</span><br><span class="line"></span><br><span class="line"><span class="comment">// attaching the MediaSource to the video tag</span></span><br><span class="line">videoTag.src = url;</span><br></pre></td></tr></table></figure>

<p>就是这样！现在你知道流媒体平台如何在网络上播放视频了！</p>
<p>开个玩笑。所以现在我们有了MediaSource，但是我们应该怎么做呢？</p>
<p>MSE规范并不止于此。它还定义了另一个概念SourceBuffers。</p>
<h3 id="资源缓冲"><a href="#资源缓冲" class="headerlink" title="资源缓冲"></a>资源缓冲</h3><p>视频实际上并未直接“推入”MediaSource进行播放，SourceBuffer用于此目的。</p>
<p>一个MediaSource包含一个或多个SourceBuffer实例。每个都与某一种类型内容相关联。这里简单地说，有三种可能的类型：</p>
<ol>
<li>audio</li>
<li>video</li>
<li>audio 和 video<blockquote>
<p>注意： 实际上，内容的“类型”由其MIME类型定义，其还可以包括关于所使用的媒体编解码器的信息</p>
</blockquote>
</li>
</ol>
<p>SourceBuffer都会链接到单个MediaSource，其中每个SourceBuffer都会被JavaScript用来将视频数据直接添加到HTML5视频标签。如下图所示：<br><img src="http://wx1.sinaimg.cn/mw690/005KEWt6ly1g5qzzp0tp2j30r308kdgi.jpg" alt="Relations between the video tag, the MediaSource, the SourceBuffers and the actual data"></p>
<p>分离视频和音频还允许在服务器端单独管理它们。这样做会带来一些好处，我们稍后会看到。这是它的工作原理：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -- 创建MediaSource并关联到video  --</span></span><br><span class="line"><span class="keyword">const</span> videoTag = <span class="built_in">document</span>.getElementById(<span class="string">"my-video"</span>);</span><br><span class="line"><span class="keyword">const</span> myMediaSource = <span class="keyword">new</span> MediaSource();</span><br><span class="line"><span class="keyword">const</span> url = URL.createObjectURL(myMediaSource);</span><br><span class="line">videoTag.src = url;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 为MediaSource添加sourceBuffer</span></span><br><span class="line"><span class="keyword">const</span> audioSourceBuffer = myMediaSource</span><br><span class="line">  .addSourceBuffer(<span class="string">`audio/mp4; codecs="mp4a.40.2"`</span>);</span><br><span class="line"><span class="keyword">const</span> videoSourceBuffer = myMediaSource</span><br><span class="line">  .addSourceBuffer(<span class="string">`video/mp4; codecs="avc1.64001e"`</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 下载并添加audio/video到SourceBuffers</span></span><br><span class="line"><span class="comment">// for the audio SourceBuffer</span></span><br><span class="line">fetch(<span class="string">"http://server.com/audio.mp4"</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// The data has to be a JavaScript ArrayBuffer</span></span><br><span class="line">  <span class="keyword">return</span> response.arrayBuffer();</span><br><span class="line">&#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">audioData</span>) </span>&#123;</span><br><span class="line">  audioSourceBuffer.appendBuffer(audioData);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// the same for the video SourceBuffer</span></span><br><span class="line">fetch(<span class="string">"http://server.com/video.mp4"</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// The data has to be a JavaScript ArrayBuffer</span></span><br><span class="line">  <span class="keyword">return</span> response.arrayBuffer();</span><br><span class="line">&#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">videoData</span>) </span>&#123;</span><br><span class="line">  videoSourceBuffer.appendBuffer(videoData);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>我们现在能够动态地将视频和音频数据添加到我们的视频标签中。</p>
<blockquote>
<p>现在是时候介绍音频和视频数据了。在前面的示例中，您可能已经注意到音频和视频数据采用mp4格式。 “mp4”是一种容器格式，它不仅包含相关的媒体数据，还包含多个元数据，例如，它所包含的媒体的开始时间和持续时间。。</p>
<p>MSE规范没有规定浏览器必须理解哪种格式。对于视频数据，最常见的两个是mp4和webm文件。前者现在非常有名，后者由谷歌赞助并基于可能更为人所知的Matroska格式（“.mkv”文件）。大多数浏览器对这两种格式都有很好的支持。</p>
</blockquote>
<p>尽管如此，许多问题仍未得到解答：</p>
<ol>
<li>我们是否必须等待下载整个内容，才能将其推送到SourceBuffer（因此能够播放）？</li>
<li>我们如何在多种质量或语言之间切换</li>
<li>如何在媒体资源尚未完成时播放实况内容（即如何实现直播）？</li>
</ol>
<h3 id="媒体片段"><a href="#媒体片段" class="headerlink" title="媒体片段"></a>媒体片段</h3><p>在上面的代码中，我们有一个<code>http://server.com/audio.mp4</code>文件代表整个音频，一个<code>http://server.com/vedio.mp4</code>文件代表整个视频。这对于非常简单的用例来说已经足够了，但如果您想要了解大多数流媒体网站提供的复杂性（切换语言，质量，播放实时内容等），这还不够。</p>
<p>在更高级的视频播放器中实际发生的是, 音/视频数据被分成多个“片段”。这些段可以有各种大小，但它们通常代表2到10秒的内容。所有这些音/视频片段形成完整的音/视频内容。这些数据块为我们之前的示例增加了一个全新的灵活性：不是一次推送整个内容，我们可以逐步推动多个音/视频片段。</p>
<p>下面有一个简单的例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// (definition of the MediaSource and its SourceBuffers)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Fetch a video or an audio segment,</span></span><br><span class="line"><span class="comment"> * and returns it as an ArrayBuffer, in a Promise.</span></span><br><span class="line"><span class="comment"> * @param &#123;string&#125; url</span></span><br><span class="line"><span class="comment"> * @returns &#123;Promise.&lt;ArrayBuffer&gt;&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fetchSegment</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> fetch(url).then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> response.arrayBuffer();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// fetching audio segments one after another (notice the URLs)</span></span><br><span class="line">fetchSegment(<span class="string">"http://server.com/audio/segment0.mp4"</span>)</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params">audioSegment0</span>) </span>&#123;</span><br><span class="line">    audioSourceBuffer.appendBuffer(audioSegment0);</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> fetchSegment(<span class="string">"http://server.com/audio/segment1.mp4"</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params">audioSegment1</span>) </span>&#123;</span><br><span class="line">    audioSourceBuffer.appendBuffer(audioSegment1);</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> fetchSegment(<span class="string">"http://server.com/audio/segment2.mp4"</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params">audioSegment2</span>) </span>&#123;</span><br><span class="line">    audioSourceBuffer.appendBuffer(audioSegment2);</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// same thing for video segments</span></span><br><span class="line">fetchSegment(<span class="string">"http://server.com/video/segment0.mp4"</span>)</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params">videoSegment0</span>) </span>&#123;</span><br><span class="line">    videoSourceBuffer.appendBuffer(videoSegment0);</span><br><span class="line">  &#125;);</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>从上面代码可以看出，在服务器端存在多个片段资源:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">./audio/</span><br><span class="line">  ├── segment0.mp4</span><br><span class="line">  ├── segment1.mp4</span><br><span class="line">  └── segment2.mp4</span><br><span class="line">./video/</span><br><span class="line">  └── segment0.mp4</span><br></pre></td></tr></table></figure>

<blockquote>
<p>⚠️ 服务器端的音/视频文件可能并没有真正被分段，客户端可以使用<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Range_requests" target="_blank" rel="noopener">HTTP range request</a>来获取分段的那些文件片段（也有可能服务器真的可以根据您的请求发送你想要的备份片段）。但是，这些情况都是实现细节。本文中我们认为服务器端有分段。</p>
</blockquote>
<p>所有这些都意味着，我们不必等待整个音/视频内容下载后才开始播放。我们经常只需媒体片段。当然，大多数播放器不会像我们代码那样为每个视频和音频片段手动执行此逻辑，但他们遵循相同的想法：按顺序下载片段并将其推入资源缓冲区（SourceBuffer）。</p>
<p>一种有趣的方式看到这个逻辑发生在现实生活中可以打开网络监视器在Firefox /铬/边缘(在Linux或windows类型“Ctrl + Shift + i”和“网络”选项卡,在Mac应该Cmd + Alt +然后我“网络”),然后启动一个视频在你最喜爱的流媒体网站。<br>你应该会看到各种视频和音频片段被快速下载:<br><img src="http://wx4.sinaimg.cn/mw690/005KEWt6ly1g5r4l6jl0oj30wk0c3dp1.jpg" alt="Screenshot of the Chrome Network tab on the Rx-Player’s demo page"></p>
<p>顺便说一下，您可能已经注意到，我们的段只是被推入源缓冲区，而没有根据时间位置指示应该推入的位置。<br>片段的容器实际上定义了它们应该放在整个媒体中的时间。这样，我们就不必在JavaScript中同步它了。</p>
<h3 id="自适应流媒体"><a href="#自适应流媒体" class="headerlink" title="自适应流媒体"></a>自适应流媒体</h3><p>许多视频播放器都有“自动质量”功能，根据用户的网络和处理能力自动选择质量。这是自适应流媒体的网络播放器的核心。这种行为也是得益于媒体切片的概念。</p>
<p>在服务端，音/视频片段实际上是以多种质量编码的。例如，我们的服务器可以存放下面的文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">./audio/</span><br><span class="line">  ├── ./128kbps/</span><br><span class="line">  |     ├── segment0.mp4</span><br><span class="line">  |     ├── segment1.mp4</span><br><span class="line">  |     └── segment2.mp4</span><br><span class="line">  └── ./320kbps/</span><br><span class="line">        ├── segment0.mp4</span><br><span class="line">        ├── segment1.mp4</span><br><span class="line">        └── segment2.mp4</span><br><span class="line">./video/</span><br><span class="line">  ├── ./240p/</span><br><span class="line">  |     ├── segment0.mp4</span><br><span class="line">  |     ├── segment1.mp4</span><br><span class="line">  |     └── segment2.mp4</span><br><span class="line">  └── ./720p/</span><br><span class="line">        ├── segment0.mp4</span><br><span class="line">        ├── segment1.mp4</span><br><span class="line">        └── segment2.mp4</span><br></pre></td></tr></table></figure>

<p>然后，Web播放器可以根据网络或CPU条件自动正确选择要下载的片段。这完全是用JavaScript完成的。对于音频片段，例如，它可能看起来像这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据片段的编号和质量推入sourceBuffer</span></span><br><span class="line"><span class="comment"> * @param &#123;number&#125; nb</span></span><br><span class="line"><span class="comment"> * @param &#123;string&#125; language</span></span><br><span class="line"><span class="comment"> * @param &#123;string&#125; wantedQuality</span></span><br><span class="line"><span class="comment"> * @returns &#123;Promise&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pushAudioSegment</span>(<span class="params">nb, wantedQuality</span>) </span>&#123;</span><br><span class="line"> <span class="comment">// The url begins to be a little more complex here:</span></span><br><span class="line"> <span class="keyword">const</span> url = <span class="string">"http://my-server/audio/"</span> +</span><br><span class="line"> wantedQuality + <span class="string">"/segment"</span> + nb + <span class="string">".mp4"</span>);</span><br><span class="line"><span class="keyword">return</span> fetch(url)</span><br><span class="line"> .then(<span class="function">(<span class="params">response</span>) =&gt;</span> response.arrayBuffer());</span><br><span class="line"> .then(<span class="function"><span class="keyword">function</span>(<span class="params">arrayBuffer</span>) </span>&#123;</span><br><span class="line"> audioSourceBuffer.appendBuffer(arrayBuffer);</span><br><span class="line"> &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">将当前的带宽转换为对应音频服务器端定义的质量。</span></span><br><span class="line"><span class="comment"> * @param &#123;number&#125; bandwidth</span></span><br><span class="line"><span class="comment"> * @returns &#123;string&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fromBandwidthToQuality</span>(<span class="params">bandwidth</span>) </span>&#123;</span><br><span class="line"> <span class="keyword">return</span> bandwidth &gt; <span class="number">320e3</span> ? <span class="string">"320kpbs"</span> : <span class="string">"128kbps"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// first estimate the bandwidth. Most often, this is based on</span></span><br><span class="line"><span class="comment">// the time it took to download the last segments</span></span><br><span class="line"><span class="keyword">const</span> bandwidth = estimateBandwidth();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> quality = fromBandwidthToQuality(bandwidth);</span><br><span class="line"></span><br><span class="line">pushAudioSegment(<span class="number">0</span>, quality)</span><br><span class="line"> .then(<span class="function"><span class="params">()</span> =&gt;</span> pushAudioSegment(<span class="number">1</span>, quality))</span><br><span class="line"> .then(<span class="function"><span class="params">()</span> =&gt;</span> pushAudioSegment(<span class="number">2</span>, quality));</span><br></pre></td></tr></table></figure>

<p>正如您所看到的，我们将不同质量的片段放在一起没有问题，javascript上的所有内容都是透明的。在任何情况下，容器文件包含足够的信息，使此过程能够顺利运行。</p>
<h3 id="多语言切换"><a href="#多语言切换" class="headerlink" title="多语言切换"></a>多语言切换</h3><p>在Netflix、Amazon Prime video或MyCanal等更复杂的网络视频播放器上，也可以根据用户设置在多种音频语言之间切换。<br>既然您已经知道了视频质量的切换方式，那么多语言切换的实现方式对您来说应该非常简单。<br>与自适应流媒体一样，我们在服务器端也有很多段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">./audio/</span><br><span class="line">  ├── ./esperanto/</span><br><span class="line">  |     ├── segment0.mp4</span><br><span class="line">  |     ├── segment1.mp4</span><br><span class="line">  |     └── segment2.mp4</span><br><span class="line">  └── ./french/</span><br><span class="line">        ├── segment0.mp4</span><br><span class="line">        ├── segment1.mp4</span><br><span class="line">        └── segment2.mp4</span><br><span class="line">./video/</span><br><span class="line">  ├── segment0.mp4</span><br><span class="line">  ├── segment1.mp4</span><br><span class="line">  └── segment2.mp4</span><br></pre></td></tr></table></figure>

<p>这一次，视频播放器切换语言不再是基于客户端功能，而是根据用户的偏好进行切换。<br>对于音频段，客户端代码大致是以下样子:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Push audio segment in the source buffer based on its number and language.</span></span><br><span class="line"><span class="comment"> * @param &#123;number&#125; nb</span></span><br><span class="line"><span class="comment"> * @param &#123;string&#125; language</span></span><br><span class="line"><span class="comment"> * @returns &#123;Promise&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pushAudioSegment</span>(<span class="params">nb, language</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// construct dynamically the URL of the segment</span></span><br><span class="line">  <span class="comment">// and push it to the SourceBuffer</span></span><br><span class="line">  <span class="keyword">const</span> url = <span class="string">"http://my-server/audio/"</span> +</span><br><span class="line">    language + <span class="string">"/segment"</span> + nb + <span class="string">".mp4"</span></span><br><span class="line">  <span class="keyword">return</span> fetch(url);</span><br><span class="line">    .then(<span class="function">(<span class="params">response</span>) =&gt;</span> response.arrayBuffer());</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">arrayBuffer</span>) </span>&#123;</span><br><span class="line">      audioSourceBuffer.appendBuffer(arrayBuffer);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// recuperate in some way the user's language</span></span><br><span class="line"><span class="keyword">const</span> language = getUsersLanguage();</span><br><span class="line"></span><br><span class="line">pushAudioSegment(<span class="number">0</span>, language)</span><br><span class="line">  .then(<span class="function"><span class="params">()</span> =&gt;</span> pushAudioSegment(<span class="number">1</span>, language))</span><br><span class="line">  .then(<span class="function"><span class="params">()</span> =&gt;</span> pushAudioSegment(<span class="number">2</span>, language));</span><br></pre></td></tr></table></figure>

<p>您可能还希望在切换语言时“清除”以前的SourceBuffer内容，以避免混合使用多语言音频内容。这可以通过SourceBuffer.prototype.remove方法实现，该方法以秒为开始和结束时间：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// remove pushed content from 0 to 40s</span></span><br><span class="line">audioSourceBuffer.remove(<span class="number">0</span>, <span class="number">40</span>);</span><br></pre></td></tr></table></figure>

<p>当然，也可以将自适应流媒体和多语言结合起来。我们可以将服务器的文件按照以下形式组织：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">./audio/</span><br><span class="line">  ├── ./esperanto/</span><br><span class="line">  |     ├── ./128kbps/</span><br><span class="line">  |     |     ├── segment0.mp4</span><br><span class="line">  |     |     ├── segment1.mp4</span><br><span class="line">  |     |     └── segment2.mp4</span><br><span class="line">  |     └── ./320kbps/</span><br><span class="line">  |           ├── segment0.mp4</span><br><span class="line">  |           ├── segment1.mp4</span><br><span class="line">  |           └── segment2.mp4</span><br><span class="line">  └── ./french/</span><br><span class="line">        ├── ./128kbps/</span><br><span class="line">        |     ├── segment0.mp4</span><br><span class="line">        |     ├── segment1.mp4</span><br><span class="line">        |     └── segment2.mp4</span><br><span class="line">        └── ./320kbps/</span><br><span class="line">              ├── segment0.mp4</span><br><span class="line">              ├── segment1.mp4</span><br><span class="line">              └── segment2.mp4</span><br><span class="line">./video/</span><br><span class="line">  ├── ./240p/</span><br><span class="line">  |     ├── segment0.mp4</span><br><span class="line">  |     ├── segment1.mp4</span><br><span class="line">  |     └── segment2.mp4</span><br><span class="line">  └── ./720p/</span><br><span class="line">        ├── segment0.mp4</span><br><span class="line">        ├── segment1.mp4</span><br><span class="line">        └── segment2.mp4</span><br></pre></td></tr></table></figure>

<p>这样，客户端必须管理语言和网络条件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Push audio segment in the source buffer based on its number, language and quality</span></span><br><span class="line"><span class="comment"> * @param &#123;number&#125; nb</span></span><br><span class="line"><span class="comment"> * @param &#123;string&#125; language</span></span><br><span class="line"><span class="comment"> * @param &#123;string&#125; wantedQuality</span></span><br><span class="line"><span class="comment"> * @returns &#123;Promise&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pushAudioSegment</span>(<span class="params">nb, language, wantedQuality</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// The url begins to be a little more complex here:</span></span><br><span class="line">  <span class="keyword">const</span> url = <span class="string">"http://my-server/audio/"</span> +</span><br><span class="line">    language + <span class="string">"/"</span> + wantedQuality + <span class="string">"/segment"</span> + nb + <span class="string">".mp4"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> fetch(url)</span><br><span class="line">    .then(<span class="function">(<span class="params">response</span>) =&gt;</span> response.arrayBuffer());</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">arrayBuffer</span>) </span>&#123;</span><br><span class="line">      audioSourceBuffer.appendBuffer(arrayBuffer);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> bandwidth = estimateBandwidth();</span><br><span class="line"><span class="keyword">const</span> quality = fromBandwidthToQuality(bandwidth);</span><br><span class="line"><span class="keyword">const</span> language = getUsersLanguage();</span><br><span class="line">pushAudioSegment(<span class="number">0</span>, language, quality)</span><br><span class="line">  .then(<span class="function"><span class="params">()</span> =&gt;</span> pushAudioSegment(<span class="number">1</span>, language, quality))</span><br><span class="line">  .then(<span class="function"><span class="params">()</span> =&gt;</span> pushAudioSegment(<span class="number">2</span>, language, quality));</span><br></pre></td></tr></table></figure>

<p>如您所见，现在有很多方法可以定义相同的内容。这揭示了分离视频和音频段相对于整个文件的另一个优势。对于后者，我们将不得不结合服务器端的所有可能性，这可能会占用更多的空间:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">segment0_video_240p_audio_esperanto_128kbps.mp4</span><br><span class="line">segment0_video_240p_audio_esperanto_320kbps.mp4</span><br><span class="line">segment0_video_240p_audio_french_128kbps.mp4</span><br><span class="line">segment0_video_240p_audio_french_320kbps.mp4</span><br><span class="line">segment0_video_720p_audio_esperanto_128kbps.mp4</span><br><span class="line">segment0_video_720p_audio_esperanto_320kbps.mp4</span><br><span class="line">segment0_video_720p_audio_french_128kbps.mp4</span><br><span class="line">segment0_video_720p_audio_french_320kbps.mp4</span><br><span class="line">segment1_video_240p_audio_esperanto_128kbps.mp4</span><br><span class="line">segment1_video_240p_audio_esperanto_320kbps.mp4</span><br><span class="line">segment1_video_240p_audio_french_128kbps.mp4</span><br><span class="line">segment1_video_240p_audio_french_320kbps.mp4</span><br><span class="line">segment1_video_720p_audio_esperanto_128kbps.mp4</span><br><span class="line">segment1_video_720p_audio_esperanto_320kbps.mp4</span><br><span class="line">segment1_video_720p_audio_french_128kbps.mp4</span><br><span class="line">segment1_video_720p_audio_french_320kbps.mp4</span><br><span class="line">segment2_video_240p_audio_esperanto_128kbps.mp4</span><br><span class="line">segment2_video_240p_audio_esperanto_320kbps.mp4</span><br><span class="line">segment2_video_240p_audio_french_128kbps.mp4</span><br><span class="line">segment2_video_240p_audio_french_320kbps.mp4</span><br><span class="line">segment2_video_720p_audio_esperanto_128kbps.mp4</span><br><span class="line">segment2_video_720p_audio_esperanto_320kbps.mp4</span><br><span class="line">segment2_video_720p_audio_french_128kbps.mp4</span><br><span class="line">segment2_video_720p_audio_french_320kbps.mp4</span><br></pre></td></tr></table></figure>

<p>服务端需要存放更多的文件，显然这些文件数据存在大量冗余信息（完全相同的视频数据包含在多个文件中），并且这种方式这在客户端也有一个缺点，因为切换音频语言可能会导致您重新下载视频（具有高带宽成本）。</p>
<h3 id="实况内容"><a href="#实况内容" class="headerlink" title="实况内容"></a>实况内容</h3><p>我们还没有谈论直播。<br>网络直播变得非常普遍（例如twitch.tv，YouTube直播流…），而且由于我们的视频和音频文件是分段的，这又一次大大简化了。</p>
<p>为用最简单的方式解释直播的基本原理，让我们考虑一个刚刚在4秒前开始直播的YouTube频道。if我们的片段内容是2秒长，那么此时YouTube的服务器应该已经产生了两个音频片段和两个视频片段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">./audio/</span><br><span class="line">  ├── segment0s.mp4</span><br><span class="line">  └── segment2s.mp4</span><br><span class="line">./video/</span><br><span class="line">  ├── segment0s.mp4</span><br><span class="line">  └── segment2s.mp4</span><br></pre></td></tr></table></figure>

<p>在直播开始的第5秒时，服务器此时还没有时间生成下一个段（第3个），所以服务器具有完全相同的可用内容。直到第6秒后，服务器产生了一个新的片段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">./audio/</span><br><span class="line">  ├── segment0s.mp4</span><br><span class="line">  ├── segment2s.mp4</span><br><span class="line">  └── segment4s.mp4</span><br><span class="line">./video/</span><br><span class="line">  ├── segment0s.mp4</span><br><span class="line">  ├── segment2s.mp4</span><br><span class="line">  └── segment4s.mp4</span><br></pre></td></tr></table></figure>

<p>这在服务器端是非常合乎逻辑的，直播内容实际上并不是真正意义上连续的，它们像非实时内容一样被分段，只是随着时间的推移，直播的片段继续逐渐出现。</p>
<p>那么，我们如何从JS知道在某个时间点上服务器上有哪些片段是可用的呢?</p>
<p>最简单的，我们可以客户端上使用计时器，用来推断新的片段在服务器端可用时的时间。我们将遵循“segmentX.mp4”命名模式，我们将每次从最后下载的一个增加“X”（segment0.mp4，然后，2秒后，Segment1.mp4等）。<br>然而，在许多情况下，这可能变得并不精确：</p>
<ol>
<li>媒体内容片段持续时间并不固定，</li>
<li>服务器在生成片段时有延迟，</li>
<li>服务器可能会为了节省空间而删除太旧的视频</li>
</ol>
<p>作为客户端，您希望尽快请求最新的片段，一旦它们可以被获取；同时也要避免在尚未生成时过早地请求它们（这将导致404 HTTP错误）。</p>
<p>通常使用传输协议（有时也称为流媒体协议）来解决此问题。</p>
<h3 id="传输协议"><a href="#传输协议" class="headerlink" title="传输协议"></a>传输协议</h3><p>对于本文来说，深入解释不同的传输协议可能过于冗长。让我们假设它们中的大多数都有相同的核心概念:Manifest。</p>
<p>Manifes是一个用来描述服务器上可用片段的文件。<br><img src="http://wx2.sinaimg.cn/mw690/005KEWt6ly1g5r8x0y252j30sh0fbq4p.jpg" alt="Example of a DASH Manifest, based on XML"><br>有了它，你可以描述在这篇文章中学到的大多数内容：</p>
<ul>
<li>哪些音频语言的内容可用，以及它们在服务器上的位置（如“在哪个URL”）</li>
<li>可用的不同音/视频质量</li>
<li>当然，如果在直播环境下，包括可使用的片段</li>
</ul>
<p>下面是一些Web中最常使用的传输协议：</p>
<ul>
<li>DASH<blockquote>
<p>YouTube，Netflix以及Amazon Prime Video等都在使用。 DASH的Manifest基于XML，被称为媒体呈现描述（或MPD）。 </p>
<p>DASH规范具有很大的灵活性，允许MPD支持大多数用例(音频描述、父级控件)，并且不依赖于编码。</p>
</blockquote>
</li>
<li>HLS<blockquote>
<p>由Apple开发，使用者包括DailyMotion，Twitch.tv等。 HLS的Manifest称为播放列表，其文件格式为m3u8 (m3u播放列表文件，用UTF-8编码)。</p>
</blockquote>
</li>
<li>Smooth Streaming<blockquote>
<p>由微软开发，被多个微软产品和MyCanal使用。在Smooth Streaming的Manifest是基于xml的。</p>
</blockquote>
<h3 id="真实的网络世界"><a href="#真实的网络世界" class="headerlink" title="真实的网络世界"></a>真实的网络世界</h3>如您所见，web视频背后的核心概念在于用JavaScript动态推送的媒体片段。<br>这种行为很快变得相当复杂，因为视频播放器需要支持很多功能:</li>
<li>下载并解析某种Manifest文件</li>
<li>监测当前的网络状况</li>
<li>用户首选项(例如，首选语言)</li>
<li>知道下载哪个部分，这至少取决于前面的两点</li>
<li>管理一个段管道，以便在正确的时间顺序下载正确的段(同时下载每个段将是低效的:您需要最早的一个段，而不是下一个)</li>
<li>处理字幕，通常完全用JS管理</li>
<li>一些视频播放器还管理一个缩略图跟踪，您可以经常看到，当悬停在进度条</li>
<li>许多服务还需要DRM管理</li>
<li>还有很多其他的…</li>
</ul>
<p>尽管如此，复杂的web兼容视频播放器仍然基于MediaSource和sourcebuffer。这就是为什么这些任务通常是由库执行的，库就是这样做的。通常，这些库甚至不定义用户界面。它们大多提供丰富的api，将Manifest和各种首选项作为参数，并在正确的源缓冲区的正确时间推送正确的片段。</p>
<p>这使得在设计媒体网站和web应用程序时具有更大的模块化和灵活性，这在本质上将是复杂的前端。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://paopaolee.github.io.com/web/LP20190705A/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="paopaolee">
      <meta itemprop="description" content="记录IT路上的风风雨雨-paopaolee">
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="paopaolee">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/web/LP20190705A/" class="post-title-link" itemprop="url">JS进阶--bind原理及实现</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-07-05 15:55:28" itemprop="dateCreated datePublished" datetime="2019-07-05T15:55:28+08:00">2019-07-05</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-07-08 14:10:00" itemprop="dateModified" datetime="2019-07-08T14:10:00+08:00">2019-07-08</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/web/" itemprop="url" rel="index"><span itemprop="name">web</span></a></span>

                
                
              
            </span>
          

          
             <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                <span class="post-count">1.5k word</span>
              </span>
          


          
             <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                <span class="post-count">6 mins</span>
              </span>
          

          
            
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <blockquote>
<p>“Programmers are in a race with the Universe to create bigger and better idiot-proof programs, while the Universe is trying to create bigger and better idiots.  So far the Universe is winning.”          —Rich Cook</p>
</blockquote>
          <!--noindex-->
          
            <div class="post-button text-center">
              <a class="btn" href="/web/LP20190705A/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://paopaolee.github.io.com/web/LP20180917A/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="paopaolee">
      <meta itemprop="description" content="记录IT路上的风风雨雨-paopaolee">
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="paopaolee">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/web/LP20180917A/" class="post-title-link" itemprop="url">JS进阶--Iterator and Generator</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-09-17 17:04:56" itemprop="dateCreated datePublished" datetime="2018-09-17T17:04:56+08:00">2018-09-17</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-03-12 10:04:32" itemprop="dateModified" datetime="2019-03-12T10:04:32+08:00">2019-03-12</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/web/" itemprop="url" rel="index"><span itemprop="name">web</span></a></span>

                
                
              
            </span>
          

          
             <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                <span class="post-count">3.5k word</span>
              </span>
          


          
             <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                <span class="post-count">14 mins</span>
              </span>
          

          
            
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <blockquote>
<p>“The best programmers are not marginally better than merely good ones.  They are an order-of-magnitude better, measured by whatever standard: conceptual creativity, speed, ingenuity of design, or problem-solving ability.”          —Randall E. Stross</p>
</blockquote>
          <!--noindex-->
          
            <div class="post-button text-center">
              <a class="btn" href="/web/LP20180917A/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/uploads/avatar.png" alt="paopaolee">
            
              <p class="site-author-name" itemprop="name">paopaolee</p>
              <div class="site-description motion-element" itemprop="description">记录IT路上的风风雨雨-paopaolee</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">1</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">12</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-balance-scale"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">paopaolee</span>

  

  
</div>









        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.2.0"></script>

  <script src="/js/motion.js?v=7.2.0"></script>



  
  


  <script src="/js/schemes/muse.js?v=7.2.0"></script>




  

  


  <script src="/js/next-boot.js?v=7.2.0"></script>


  

  

  

  



  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
